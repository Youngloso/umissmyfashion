<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - U Miss My Fashion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #fff; color: #000; margin: 0; padding-bottom: 100px; }
        .checkout-container { max-width: 800px; margin: 60px auto; padding: 0 20px; text-align: center; }
        .step-section { margin-bottom: 80px; }
        .step-num { font-size: 100px; font-weight: bold; margin: 0; line-height: 1; }
        .step-title { font-size: 32px; font-weight: bold; margin: 10px 0 40px 0; }
        .billing-form { text-align: left; max-width: 600px; margin: 0 auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group label { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .form-group input, .form-group textarea { padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; outline: none; }
        .order-review-box { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 25px; text-align: left; max-width: 650px; margin: 0 auto; }
        .item-list-row { display: flex; align-items: center; gap: 15px; padding: 20px 0; border-bottom: 1px solid #f5f5f5; }
        .item-list-row img { width: 70px; height: 85px; object-fit: cover; border-radius: 4px; }
        .item-details { flex: 1; }
        .item-details h4 { margin: 0; font-size: 16px; font-weight: bold; }
        .qty-wrapper { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; width: fit-content; margin-top: 8px; }
        .qty-btn { background: none; border: none; padding: 5px 12px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .qty-num { padding: 0 12px; font-size: 14px; border-left: 1px solid #ddd; border-right: 1px solid #ddd; min-width: 25px; text-align: center; }
        .item-price-end { font-weight: bold; font-size: 16px; min-width: 80px; text-align: right; }
        .summary-details { margin-top: 25px; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; color: #444; }
        .grand-total-line { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 2px solid #000; font-size: 22px; font-weight: bold; }
        .payment-box { background: #f9f9f9; padding: 40px; border-radius: 8px; border: 1px solid #eee; max-width: 500px; margin: 0 auto; }
        .btn-gb-pay { width: 100%; background: #333; color: #fff; border: none; padding: 18px; font-size: 18px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .btn-gb-pay:hover { background: #000; }
    </style>
</head>
<body>

    <div class="checkout-container">
        <div class="step-section">
            <p class="step-num">1.</p>
            <h2 class="step-title">Billing details</h2>
            <div class="billing-form">
                <div class="form-row">
                    <div class="form-group"><label>ชื่อจริง *</label><input type="text" id="fname" required></div>
                    <div class="form-group"><label>นามสกุล *</label><input type="text" id="lname" required></div>
                </div>
                <div class="form-group"><label>ที่อยู่จัดส่ง *</label><textarea id="address" rows="3" required></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>จังหวัด *</label><input type="text" id="province" required></div>
                    <div class="form-group"><label>รหัสไปรษณีย์ *</label><input type="text" id="zipcode" required></div>
                </div>
                <div class="form-group"><label>เบอร์โทรศัพท์ *</label><input type="tel" id="phone" required></div>
            </div>
        </div>

        <div class="step-section">
            <p class="step-num">2.</p>
            <h2 class="step-title">Check Your Order</h2>
            <div class="order-review-box" id="checkout-container"></div>
        </div>

        <div class="step-section">
            <p class="step-num">3.</p>
            <h2 class="step-title">Payment Information</h2>
            <div class="payment-box">
                <p><b>ยืนยันการสั่งซื้อ</b></p>
                <p style="font-size: 13px; color: #666; margin-bottom: 25px;">กรุณาตรวจสอบข้อมูลให้ครบถ้วนก่อนกดชำระเงิน</p>
                <button id="submit-payment" class="btn-gb-pay">CONTINUE TO PAYMENT</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // 2. Config ของนาย
    const firebaseConfig = {
        apiKey: "AIzaSyADf4UCa5gifG0F0Ewq5XRM6-QSoxpMZ10",
        authDomain: "umissmyfashion.firebaseapp.com",
        projectId: "umissmyfashion",
        storageBucket: "umissmyfashion.firebasestorage.app",
        messagingSenderId: "520982702803",
        appId: "1:520982702803:web:9f9ca86412385d4b9a8226",
        measurementId: "G-M1H6KNH1S9"
    };

    // 3. เริ่มการทำงาน
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const payBtn = document.getElementById('submit-payment');

    if (payBtn) {
        payBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log("เริ่มกดปุ่ม...");

            try {
                // เช็ค Login
                const user = auth.currentUser;
                if (!user) {
                    alert("กรุณา Login ก่อนชำระเงินครับ");
                    return;
                }

                // ดึงข้อมูล
                const totalText = document.querySelector('.grand-total-line span:last-child')?.innerText || "0";
                const cleanTotal = parseInt(totalText.replace(/[^0-9]/g, '')) || 0;
                const cartItems = JSON.parse(localStorage.getItem('cart')) || [];

                // บันทึกข้อมูล
                alert("กำลังดำเนินการสั่งซื้อ");
                
                await addDoc(collection(db, "orders"), {
                    userId: user.uid,
                    userEmail: user.email,
                    items: cartItems,
                    totalPrice: cleanTotal,
                    status: "กำลังรอดำเนินการ",
                    createdAt: serverTimestamp()
                });

                alert("สั่งซื้อสำเร็จ");
                window.location.href = 'payment.html';

            } catch (error) {
                console.error(error);
                alert("เกิดข้อผิดพลาด: " + error.message);
            }
        });
    }
</script>

    <script>
        function renderCheckout() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const container = document.getElementById('checkout-container');
            
            if (cart.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>ไม่มีสินค้าในตะกร้า</p>";
                return;
            }

            let subtotal = 0;
            let itemsHtml = '';

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                itemsHtml += `
                    <div class="item-list-row">
                        <img src="${item.image}">
                        <div class="item-details">
                            <h4>${item.name} (${item.size})</h4>
                            <div class="qty-wrapper">
                                <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                                <span class="qty-num">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                            </div>
                        </div>
                        <div class="item-price-end">฿${itemTotal.toLocaleString()}</div>
                    </div>
                `;
            });

            const shipping = 70;
            container.innerHTML = `
                ${itemsHtml}
                <div class="summary-details">
                    <div class="summary-line"><span>ยอดรวม</span><span>฿${subtotal.toLocaleString()}</span></div>
                    <div class="summary-line"><span>การจัดส่ง (EMS)</span><span>฿${shipping}</span></div>
                    <div class="grand-total-line"><span>รวมทั้งสิ้น</span><span>฿${(subtotal + shipping).toLocaleString()}</span></div>
                </div>
            `;
        }

        function updateQty(index, change) {
            let cart = JSON.parse(localStorage.getItem('cart'));
            cart[index].quantity += change;
            if (cart[index].quantity < 1) {
                if(confirm("ต้องการลบสินค้านี้ออกจากรายการใช่หรือไม่?")) {
                    cart.splice(index, 1);
                } else {
                    cart[index].quantity = 1;
                }
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCheckout();
        }

        document.addEventListener('DOMContentLoaded', renderCheckout);
    </script>
</body>
</html>
